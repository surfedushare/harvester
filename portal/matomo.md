Matomo
======

Some documentation on how the Harvester can work with data coming from Matomo.


Page view
---------

For every navigation action by the user we want to see page view data.
This is how we [push that data to Matomo](src/logging.js#L69-L74).


Is staff dimension
------------------

We use the first dimension as an ["is staff" dimension](src/logging.js#L90).
For logged in users that are part of the SURF team we set this dimension and we can exclude the data with this dimension from our analysis.


GET parameters in the search results URL
----------------------------------------

We want the GET parameters on search result pages to reflect the search query.
That way we can tell what users were searching for and whether they are happy with the results.
The format of these GET parameters follows a strict format. The parsing is done by some [helper functions](src/components/_helpers.js).
We expect the parameters in the [url that gets send to Matomo](../harvester/core/fixtures/matomo-visits.json#L32).
The path and domain are less important than the parameters, because the parameters tell us a lot about search intent.


Similarity suggestion click
---------------------------

People can click on suggestions based on the similarity of the item the user is viewing.
To determine how successful the suggestions are we want to know when these suggestions get clicked upon.
We use a [custom event](src/logging.js#L78-L85) to achieve this and the second dimension is set to `more_like_this`.
Here is the [exact definition of the custom event](src/pages/material.vue#L107-L109).
Passing on the data like this to Matomo should result in an event object with the correct event data set:

* [URL property](../harvester/core/fixtures/matomo-visits.json#L91) (should contain the identifier of the item)
* [Event category and action properties](../harvester/core/fixtures/matomo-visits.json#L96-L97) (fixed values)
* [Event name property](../harvester/core/fixtures/matomo-visits.json#L106) (the external_id of the suggestion)


Download click
--------------

We also want to set a [custom event](src/logging.js#L78-L85) for the download of a file.
We use this download as an indication of the interests of the user in an item.
Here is again the [exact definition of the custom event](src/components/Materials/Sidebar/Sidebar.component.js#L306-L312).
As a custom dimension we send along the name of the consortium that the item is made by.
This third custom dimension is not really used in analysis and is more there for reporting purposes on how popular consortia are.
Passing on the data like this to Matomo should result in an event object with the correct event data set:

* [URL property](../harvester/core/fixtures/matomo-visits.json#L132) (should contain the identifier of the item)
* [Event category and action properties](../harvester/core/fixtures/matomo-visits.json#L137-L138) (fixed values)
* [Event name property](../harvester/core/fixtures/matomo-visits.json#L147) (the download link)


Visitor identifier
------------------

We need the Matomo instance to be configured to store and export the visitor id.
The output of Matomo should [contain the visitor id](../harvester/core/fixtures/matomo-visits.json#L6).
That way we can link actions and events from the same visitor id and for instance do suggestions based on download behaviour of different visitors.


Matomo configuration
--------------------

To be able to work with the Matomo data the instance gathering the data should have a specific configuration:

* IP addresses may get filtered and this is probably best enabled because of GDPR
* The [Live](https://developer.matomo.org/api-reference/reporting-api#Live) module should be enabled
* Visitor ids should get stored and exported through the Live module
* dimension1 should indicate whether data is generated by a SURF staff member or real user
* dimension2 should indicate whether the action or event happened in context of the "more like this" similarity feature
* When in doubt please reference the [Matomo data fixture](../harvester/core/fixtures/matomo-visits.json) to see how the Harvester expects the data
